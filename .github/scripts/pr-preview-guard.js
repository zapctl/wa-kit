module.exports = async ({ github, context, core }) => {
  const status = core.getInput('status') || process.env.PUBLISH_STATUS || 'started';
  const version = core.getInput('version') || process.env.PREVIEW_VERSION || '';
  const packageName = core.getInput('package_name') || process.env.PACKAGE_NAME || 'wa-kitchen';

  console.log(`Status: ${status}`);
  console.log(`Version: ${version}`);
  console.log(`Package: ${packageName}`);

  // Encontrar o PR associado ao branch atual
  async function findAssociatedPR() {
    const branch = context.ref.replace('refs/heads/', '');
    console.log(`Finding PR for branch: ${branch}`);

    const { data: pullRequests } = await github.rest.pulls.list({
      owner: context.repo.owner,
      repo: context.repo.repo,
      state: 'open'
    });

    const pr = pullRequests.find(pr => pr.head.ref === branch);

    if (pr) {
      console.log(`Found PR #${pr.number}`);
      return pr.number;
    }

    console.log('No PR found for this branch');
    return null;
  }

  // Criar ou atualizar check de bloqueio
  async function createBlockingCheck(prNumber, checkStatus) {
    const checkName = 'preview-publish-guard';

    let checkParams;

    if (checkStatus === 'started') {
      checkParams = {
        owner: context.repo.owner,
        repo: context.repo.repo,
        name: checkName,
        head_sha: context.sha,
        status: 'in_progress',
        output: {
          title: 'üöÄ Publishing preview version...',
          summary:
            '‚ö†Ô∏è **PR merge is blocked until preview publication completes.**\n\n' +
            'A preview version is being published to NPM. Please wait for the process to finish.\n\n' +
            `**Version:** ${version || 'generating...'}\n\n` +
            `[View workflow run](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})`
        }
      };
    } else if (checkStatus === 'success') {
      const npmUrl = `https://www.npmjs.com/package/${packageName}/v/${version}`;
      checkParams = {
        owner: context.repo.owner,
        repo: context.repo.repo,
        name: checkName,
        head_sha: context.sha,
        status: 'completed',
        conclusion: 'success',
        output: {
          title: `‚úÖ Preview v${version} published successfully`,
          summary:
            '## üéâ Preview version published to NPM\n\n' +
            `**Version:** \`${version}\`\n\n` +
            `**NPM Package:** [${packageName}@${version}](${npmUrl})\n\n` +
            '‚úÖ **PR can now be merged.**\n\n' +
            `[View workflow run](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})`
        }
      };
    } else if (checkStatus === 'failure') {
      checkParams = {
        owner: context.repo.owner,
        repo: context.repo.repo,
        name: checkName,
        head_sha: context.sha,
        status: 'completed',
        conclusion: 'failure',
        output: {
          title: '‚ùå Preview publication failed',
          summary:
            'Preview publication encountered an error.\n\n' +
            '‚ö†Ô∏è **PR merge remains blocked** until the issue is resolved.\n\n' +
            `[View workflow run](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})\n\n` +
            'Please check the workflow logs for more information.'
        }
      };
    }

    console.log(`Creating check with status: ${checkStatus}`);
    await github.rest.checks.create(checkParams);
  }

  // Comentar no PR
  async function commentOnPR(prNumber, commentStatus) {
    let body;

    if (commentStatus === 'started') {
      body =
        '## üöÄ Preview Publication Started\n\n' +
        '‚ö†Ô∏è **PR merge is blocked** until preview publication completes.\n\n' +
        'A preview version is being published to NPM. This ensures that the package is available before merging.\n\n' +
        `**Status:** Publishing ${version ? `v${version}` : 'preview version'}...\n\n` +
        `**Workflow Run:** [View details](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})\n\n` +
        '---\n' +
        '*This comment was automatically generated by the preview publication workflow.*';
    } else if (commentStatus === 'success') {
      const npmUrl = `https://www.npmjs.com/package/${packageName}/v/${version}`;
      body =
        '## ‚úÖ Preview Publication Completed\n\n' +
        `The preview version **v${version}** has been successfully published to NPM.\n\n` +
        'üéâ **PR merge is now unblocked** - you can proceed with merging.\n\n' +
        `**NPM Package:** [${packageName}@${version}](${npmUrl})\n\n` +
        '### Installation\n' +
        '```bash\n' +
        `npm install ${packageName}@${version}\n` +
        '```\n\n' +
        `**Workflow Run:** [View details](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})\n\n` +
        '---\n' +
        '*This comment was automatically generated by the preview publication workflow.*';
    } else if (commentStatus === 'failure') {
      body =
        '## ‚ùå Preview Publication Failed\n\n' +
        'The preview publication encountered an error.\n\n' +
        '‚ö†Ô∏è **PR merge remains blocked** until the issue is resolved.\n\n' +
        `**Workflow Run:** [View details](${context.payload.repository?.html_url || context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo}/actions/runs/${context.runId})\n\n` +
        'Please check the workflow logs for more information.\n\n' +
        '---\n' +
        '*This comment was automatically generated by the preview publication workflow.*';
    }

    console.log(`Commenting on PR #${prNumber}`);
    await github.rest.issues.createComment({
      owner: context.repo.owner,
      repo: context.repo.repo,
      issue_number: prNumber,
      body: body
    });
  }

  // Execu√ß√£o principal
  const prNumber = await findAssociatedPR();

  if (!prNumber) {
    console.log('No PR found, skipping guard actions');
    return;
  }

  console.log(`Processing guard for PR #${prNumber} with status: ${status}`);

  // Criar check de bloqueio
  await createBlockingCheck(prNumber, status);

  // Comentar no PR
  await commentOnPR(prNumber, status);

  console.log('PR guard completed successfully');
};
